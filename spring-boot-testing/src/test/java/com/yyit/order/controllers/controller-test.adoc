= ç¼–å†™å•å…ƒæµ‹è¯•ï¼šæ§åˆ¶å™¨å±‚


ç”±äºæˆ‘ä»¬çš„ API å·²ç»å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬åº”è¯¥æœ‰ä¸€ä¸ªæ§åˆ¶å™¨å±‚ã€‚æ­£å¦‚æˆ‘ä¹‹å‰æ‰€è¯´ï¼Œåœ¨ä¸ºæ§åˆ¶å™¨å±‚ç¼–å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œ
æˆ‘ä»¬åº”è¯¥ç¡®ä¿å…¶ä»–å±‚ï¼ˆrepository/serviceï¼‰ä¸å—å½±å“ã€‚æˆ‘ä»¬å¿…é¡»æ¨¡æ‹Ÿå¯¹è±¡ï¼

è¿™æ˜¯æ§åˆ¶å™¨æµ‹è¯•ç±»çš„åŸºæœ¬ç»“æ„ï¼

[source,java]
----
@ExtendWith(SpringExtension.class)
@WebMvcTest(OrderController.class)
public class OrderControllerUnitTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private OrderService orderService;

}
----

* ä½¿ç”¨ *WebMvcTest* æ³¨è§£å°†ç¦ç”¨å®Œå…¨è‡ªåŠ¨é…ç½®ï¼Œè€Œä»…åº”ç”¨ä¸ MVC æµ‹è¯•ç›¸å…³çš„é…ç½®ï¼ˆå³ `@Controller`ã€`@ControllerAdvice`ã€`@JsonComponent`ã€`Converter`/`GenericConverter`ã€`Filter`ã€`WebMvcConfigurer` å’Œ `HandlerMethodArgumentResolver` bean ä½†ä¸æ˜¯ `@Component`ã€`@Service` æˆ– `@Repository` beanï¼‰â€”â€”æ¥æºï¼šJava doc
* *SpringExtension* å°† Spring TestContext Framework é›†æˆåˆ° JUnit 5 çš„ Jupiter ç¼–ç¨‹æ¨¡å‹ä¸­ã€‚
* *MockMVC* ç±»æ˜¯ Spring MVC æµ‹è¯•æ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæœ‰åŠ©äºæµ‹è¯•æ§åˆ¶å™¨æ˜¾å¼å¯åŠ¨ Servlet å®¹å™¨ã€‚
* *MockBean* ç”¨äºå°†æ¨¡æ‹Ÿå¯¹è±¡æ·»åŠ åˆ° Spring åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ã€‚è¿™ç§æ–¹å¼å¯ä»¥åˆ›å»ºå‡å¯¹è±¡å¹¶æ‰§è¡Œæ“ä½œã€‚æˆ‘ä»¬éœ€è¦åœ¨æ­¤å¤„æ³¨å…¥ *Service* çš„æ¨¡æ‹Ÿæ¥æ‰§è¡Œæ¨¡æ‹Ÿè¡Œä¸ºã€‚ç¨åå°†è®¨è®ºã€‚

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ä¸ºè·å–è®¢å•çš„æ–¹æ³•ç¼–å†™ä¸€ä¸ªæµ‹è¯•ã€‚

[source,java]
----
@Test
public void testGetOrdersList() throws Exception {
    when(orderService.getOrders()).thenReturn(Collections.singletonList(order));
    mockMvc.perform(get("/api/orders"))
        .andDo(print())
        .andExpect(status().isOk())
        .andExpect(content().contentType(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$", hasSize(1)))
        .andExpect(jsonPath("$").isArray());
}
----

æˆ‘å°†åœ¨è¿™é‡Œé€è¡Œè§£é‡Šâ€¦ ğŸ˜

*Mockito When å­å¥*

[quart]
____
Mockito ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æ¨¡æ‹Ÿå®é™…è¡Œä¸ºçš„æ–¹æ³•ã€‚å®ƒçš„æ ¼å¼æ˜¯è¿™æ ·çš„â€¦

when(something happens).thenReturn(do something)

OR thenThrow(exception)
____

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥è°ƒç”¨ order service å±‚å¹¶åœ¨ *when()* å­å¥ä¸­è·å–è®¢å•ã€‚
è¯¥æ–¹æ³•åº”è¯¥è¿”å›æˆ‘ä»¬æ”¾åœ¨ *thenReturn()* ä¸­çš„å“åº”ã€‚åœ¨æ­¤è¡Œä¹‹åï¼Œæ­¤æµ‹è¯•æ–¹æ³•å°†æ‰§è¡Œæ¨¡æ‹Ÿæ“ä½œè¿è¡Œæ—¶å¹¶ä¸ºä¸‹ä¸€æ­¥å‡†å¤‡è®¢å•åˆ—è¡¨ã€‚

ç„¶åæˆ‘ä»¬è°ƒç”¨ *MockMvc* å¯¹è±¡å¹¶ä½¿ç”¨ç›¸å…³ URL æ‰§è¡Œ GET API è°ƒç”¨ã€‚
ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»æ„æ•°é‡çš„ *ResultAction* ç»‘å®šåˆ°æ­¤ API è°ƒç”¨ã€‚

*â€” andDo(print())*: æ‰“å°ç»“æœ
*â€” andExpect()*: åœ¨å“åº”ä½“ã€å“åº”æ ¼å¼ã€å“åº”çŠ¶æ€ç ç­‰å„ä¸ªæ–¹é¢è®¾ç½®é¢„æœŸç»“æœã€‚

æˆ‘å·²ç»æ£€æŸ¥äº†è¿™äº›ç‚¹: â€” API è¿”å› 200 çŠ¶æ€ç  => *isOk()* æ–¹æ³• â€” å“åº”å†…å®¹æ˜¯ JSON => *content()* æ–¹æ³• â€” å“åº” JSON æ˜¯å¦åŒ…å«æ•°ç»„ => *isArray()* æ–¹æ³• â€” å“åº”å¤§å°æ˜¯å¦ä¸º 1 => *hasSize()* æ–¹æ³•

ğŸ”´ è¿™é‡Œï¼Œâ€œ$â€ è¡¨ç¤ºå“åº” JSON æ ¹çº§åˆ«ã€‚å› ä¸ºè¿™ä¸ª GET API æ˜¯è¿™æ ·è¿”å›å“åº”çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä½¿ç”¨é‚£ä¸ªè¡¨ç¤ºæ³•ã€‚

[source,json]
----
[
    {
        "id": 1,
        "buyer": "peter",
        "price": 30.0,
        "qty": 3
    }
]
----

å¦‚æœæˆ‘ä»¬æœ‰ä¸åŒåµŒå¥—æ ¼å¼çš„ç»“æœï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ç›¸å…³çš„é”®ã€‚å‡è®¾æˆ‘ä»¬åœ¨ â€œdataâ€ é”®ä¸­åŒ…å«ç»“æœã€‚

[source,json]
----
{
    "data": [
       {
            "id": 1,
            "buyer": "peter",
            "price": 30.0,
            "qty": 3
        }
    ]
}
----

ç„¶åæˆ‘ä»¬åº”è¯¥åƒè¿™æ ·æ›´æ”¹ä»£ç ï¼š

[source,java]
----
.andExpect(jsonPath("$.data", hasSize(1)))
.andExpect(jsonPath("$.data").isArray());
----

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè·å–è®¢å•çš„æµ‹è¯•ã€‚

ä¹Ÿä¼šå¦‚æ­¤ã€‚å”¯ä¸€çš„å˜åŒ–æ˜¯å“åº”æ ¼å¼â€”â€”å¯¹è±¡è€Œä¸æ˜¯æ•°ç»„ã€‚

[source,java]
----
@Test
public void testGetOrderById() throws Exception {
    when(orderService.getOrderById(10L)).thenReturn(order);
    mockMvc.perform(get("/api/orders/10"))
        .andDo(print())
        .andExpect(status().isOk())
        .andExpect(content().contentType(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$.buyer", is("andrew")))
        .andExpect(jsonPath("$.id", is(10)))
        .andExpect(jsonPath("$").isNotEmpty());
}
----

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ª**åˆ›å»ºæ–°è®¢å•**çš„æµ‹è¯•ã€‚
ä¹Ÿä¸€æ ·ï¼Œä½†è¿™æ¬¡ MockMvc å°†ä½¿ç”¨æ–¹æ³•ä½“æ‰§è¡Œ *POST* è°ƒç”¨ï¼æˆ‘ä»¬å¿…é¡»æä¾›ä¸€ä¸ª JSON å­—ç¬¦ä¸²ä½œä¸ºè¯·æ±‚ä½“ã€‚
æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„ *Pojo è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²*ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ *Jackson* library ä¸­çš„ *Object Mapper*ã€‚

[source,java]
----
private final ObjectMapper objectMapper = new ObjectMapper();
----

æˆ‘åˆ›å»ºäº† POST API æ¥è¿”å› 201 çŠ¶æ€ä»£ç ã€‚
å› æ­¤ï¼Œåœ¨ Result æ“ä½œä¸­ï¼Œæˆ‘ä½¿ç”¨ *isCreated() â€” 201* æ–¹æ³•æ¥åŒ¹é…å“åº”çŠ¶æ€ï¼Œè€Œä¸æ˜¯ *isOk() â€” 200* æ–¹æ³•ã€‚

[source,java]
----
@Test
public void testCreateOrder() throws Exception {
    when(orderService.createOrder(order)).thenReturn(order);
    mockMvc.perform(
        post("/api/orders")
            .content(objectMapper.writeValueAsString(order))
            .contentType(MediaType.APPLICATION_JSON)
        )
        .andDo(print())
        .andExpect(status().isCreated())
        .andExpect(content().contentType(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$.buyer", is("andrew")))
        .andExpect(jsonPath("$.id", is(10)))
        .andExpect(jsonPath("$").isNotEmpty());
}
----

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ä¸º**åˆ é™¤ Order çš„æ–¹æ³•**ç¼–å†™ä¸€ä¸ªæµ‹è¯•ã€‚

[source,java]
----
@Test
public void testDeleteOrder() throws Exception {
    Order order = new Order(10L, "andrew", 40.0, 2);
    when(orderService.deleteOrderById(order.getId())).thenReturn(true);
    mockMvc.perform(delete("/api/orders/" + order.getId()))
        .andDo(print())
        .andExpect(status().isOk());
}
----

åŒæ ·çš„äº‹æƒ…ä¹Ÿå‘ç”Ÿåœ¨è¿™é‡Œã€‚æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸­ä¸º DELETE è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚ğŸ˜

ç°åœ¨æ§åˆ¶å™¨çš„åŸºæœ¬æµ‹è¯•ç”¨ä¾‹å·²ç»å®Œæˆï¼ â¤ï¸


ç°åœ¨è¿è¡Œæµ‹è¯•ç±»å¹¶æŸ¥çœ‹ç»“æœâ€¦ ğŸ’ª å…¨éƒ¨é€šè¿‡! ğŸ˜