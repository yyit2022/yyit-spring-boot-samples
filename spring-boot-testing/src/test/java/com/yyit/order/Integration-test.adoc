= ç¼–å†™é›†æˆæµ‹è¯•

æ­£å¦‚æˆ‘ä¹‹å‰æåˆ°çš„ï¼Œè¿™ä¸åƒå•å…ƒæµ‹è¯•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»æ”¹å˜æ•´ä¸ªæ–¹æ³•ã€‚
ä¸ºæˆ‘ä»¬çš„è®¢å•æœåŠ¡ç¼–å†™é›†æˆæµ‹è¯•çš„ç›®çš„æ˜¯**ç¡®ä¿ä¸è®¢å•ç›¸å…³çš„åŠŸèƒ½åœ¨è¿æ¥æµç¨‹ä¸­çš„æ‰€æœ‰å±‚æ—¶éƒ½èƒ½æ­£å¸¸å·¥ä½œ**ã€‚
å±‚å°†æ˜¯ controllerã€serviceã€repositoryã€entityã€å¼‚å¸¸é…ç½®ç­‰ã€‚

æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åœ¨è¿™é‡Œå˜²ç¬‘â€¦â€¦å¯¹ï¼æˆ‘ä»¬å¿…é¡»åšä¸€äº›å®é™…çš„æ“ä½œã€‚è®©æˆ‘ä»¬é¦–å…ˆä¸ºæ­¤è®¾ç½®ç±»ã€‚

[source,java]
----
package com.rest.order;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.rest.order.models.Order;
import com.rest.order.repositories.OrderRepository;
import com.rest.order.services.OrderService;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.*;
import org.springframework.test.context.jdbc.Sql;

import java.util.List;
import java.util.Objects;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;


@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class OrderApiIntegrationTest {

    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private OrderRepository orderRepository;

    @Autowired
    private OrderService orderService;

    private static HttpHeaders headers;

    private final ObjectMapper objectMapper = new ObjectMapper();

    @BeforeAll
    public static void init() {
        headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
    }
    private String createURLWithPort() {
        return "http://localhost:" + port + "/api/orders";
    }
}
----

*SpringBootTest* æ³¨è§£**åŠ è½½å®Œæ•´çš„ Spring åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡å¹¶æä¾›ä¸€ä¸ªæ¨¡æ‹Ÿ Web ç¯å¢ƒ**ã€‚
æˆ‘å·²ç»ç»™å‡ºäº†ä¸€ä¸ªé™„åŠ æ¡ä»¶ï¼Œå¯ä»¥åœ¨**éšæœºç«¯å£**ä¸Šå¯åŠ¨æ¨¡æ‹Ÿ Web ç¯å¢ƒï¼

*LocalServerPort* æ³¨è§£ç”¨äºå°†è¯¥ç«¯å£ç»‘å®šåˆ° API URLã€‚ç„¶åæˆ‘åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•ä¸­æ„å»ºäº† URLï¼Œå¯ä»¥åœ¨æ•´ä¸ªç±»ä¸­é‡ç”¨ã€‚


ç°åœ¨æˆ‘å·²ç»**__æ³¨å…¥äº†çœŸæ­£çš„ service å’Œ repository å±‚__**â€”â€”ä¸åƒä»¥å‰é‚£æ ·ã€‚æˆ‘ä½¿ç”¨äº† *Autowired* æ³¨è§£è€Œä¸æ˜¯ Mock æˆ– MockBeanï¼

æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨ *TestRestTemplate* é€šè¿‡æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰§è¡Œ API è°ƒç”¨ï¼

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ä¸º**è·å–è®¢å•çš„æ–¹æ³•**ç¼–å†™ä¸€ä¸ªé›†æˆæµ‹è¯•ã€‚

[source,java]
----
@Test
@Sql(statements = "INSERT INTO orders(id, buyer, price, qty) VALUES (2, 'john', 24, 1)", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(statements = "DELETE FROM orders WHERE id='2'", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public void testOrdersList() {
    HttpEntity<String> entity = new HttpEntity<>(null, headers);
    ResponseEntity<List<Order>> response = restTemplate.exchange(
            createURLWithPort(), HttpMethod.GET, entity, new ParameterizedTypeReference<List<Order>>(){});
    List<Order> orderList = response.getBody();
    assert orderList != null;
    assertEquals(response.getStatusCodeValue(), 200);
    assertEquals(orderList.size(), orderService.getOrders().size());
    assertEquals(orderList.size(), orderRepository.findAll().size());
}
----

æœ‰ä»€ä¹ˆæ–°ä¸œè¥¿åœ¨è¿™é‡Œå—ï¼Ÿ ğŸ˜

æ‚¨åº”è¯¥çœ‹åˆ° *â€œSqlâ€* æ³¨è§£ã€‚å®ƒçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿå¥½å§â€¦â€¦æˆ‘å‘Šè¯‰è¿‡ä½ æˆ‘ä»¬å°†é‡‡å–å®é™…è¡ŒåŠ¨ã€‚
å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥**ç¡®ä¿æˆ‘ä»¬çš„æ•°æ®åº“åœ¨å¼€å‘å›¢é˜Ÿä¸­çš„ä»»ä½•äººè¿è¡Œé›†æˆæµ‹è¯•åæ²¡æœ‰å—åˆ°æ±¡æŸ“**ï¼
æ•°æ®ä¸åº”è¯¥æ”¹å˜ï¼æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªæµ‹è¯•æ–¹æ³•ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œå¹¶å‘Šè¯‰ Spring Boot æˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæµ‹è¯•æ—¶**æ‰§è¡Œä¸€äº›æ‰‹åŠ¨ SQL å‘½ä»¤**ã€‚

ä¾‹å¦‚ï¼šå¦‚æœæˆ‘ä»¬åœ¨æµ‹è¯• POST API è°ƒç”¨æ—¶åˆ›å»ºä¸€ä¸ªæ–°è®¢å•ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
æœ‰æ„å¤–çš„æ•°æ®å—ï¼Ÿç„¶åæˆ‘ä»¬æ”¹å˜äº†åŸå§‹æ•°æ®ï¼è¿™æ˜¯ä¸æ­£ç¡®çš„â€¦â€¦é‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšï¼Ÿ
*è¿è¡Œæµ‹è¯•ç”¨ä¾‹åï¼Œæˆ‘ä»¬åº”è¯¥åˆ é™¤è¯¥å‘½ä»¤*ï¼ç®€å•çš„ï¼ğŸ˜ƒ

æˆ‘ä½¿ç”¨äº† 2ï¸âƒ£ ä¸ª SQL å‘½ä»¤æ¥åˆ›å»ºå’Œåˆ é™¤æ¯ä¸ªæµ‹è¯•å¯¹è±¡ã€‚
æˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªåä¸º *executionPhase* çš„å‚æ•°ã€‚
åº”ç”¨ç¨‹åºåº”è¯¥åœ¨å“ªä¸ªé˜¶æ®µæ‰§è¡Œ SQL å‘½ä»¤ä¼šå¾ˆé‡è¦ã€‚
æ‰€ä»¥æˆ‘ä½¿ç”¨äº† `BEFORE_TEST_METHOD` æ¥è¡¨ç¤º `SAVE` å’Œ `AFTER_TEST_METHOD` æ¥è¡¨ç¤º `DELETE`ã€‚

* æˆ‘åœ¨ `TestRestTeamplate` ç±»ä¸­ä½¿ç”¨äº† exchange æ–¹æ³•ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæˆ‘æœŸæœ›ä¸€ä¸ªè®¢å•åˆ—è¡¨ã€‚
* è¿™é‡Œéœ€è¦ *HttpEntity* å¯¹è±¡ä½œä¸ºå‚æ•°å‘é€ã€‚
ç”±äº GET è°ƒç”¨ä¸éœ€è¦æ–¹æ³•ä½“ï¼Œå› æ­¤æˆ‘ä½¿ç”¨ NULL æ­£æ–‡åˆ›å»ºäº†å®ƒã€‚
* *Headers* å·²åœ¨ *BeforeAll* æµ‹è¯•æ³¨è§£ä¸­åˆå§‹åŒ–ã€‚

ç„¶åæˆ‘ä»¬åªéœ€è¦å°†å“åº”ä¸å¯¹ service å’Œ repository å±‚çš„ç›´æ¥æ–¹æ³•è°ƒç”¨è¿›è¡Œæ¯”è¾ƒã€‚çŠ¶æ€ç è¿˜æ£€æŸ¥å…¶æ˜¯å¦ä¸º 200ã€‚
*ç„¶åæˆ‘ä»¬å¯ä»¥ä¿è¯ï¼Œå¦‚æœæœ‰äººä»å¤–éƒ¨æºè°ƒç”¨ APIï¼Œå®ƒä¼šç»™å‡ºæ­£ç¡®çš„ç»“æœï¼Œå°±åƒ repository å’Œ service å•ç‹¬ç»™å‡ºçš„ä¸€æ ·*.

[source,java]
----
assertEquals(orderList.size(), orderService.getOrders().size());
assertEquals(orderList.size(), orderRepository.findAll().size());
----

ç”±äºæˆ‘ä½¿ç”¨ SQL å‘½ä»¤åªæ’å…¥äº† 1 ä¸ªå¯¹è±¡ï¼Œå› æ­¤è¯¥æµ‹è¯•å°†ç¡®ä¿å“åº”å¤§å°ä¸º 1ã€‚

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ä¸º**é€šè¿‡ ID è·å– Order çš„æ–¹æ³•**ç¼–å†™ä¸€ä¸ªé›†æˆæµ‹è¯•ã€‚
æˆ‘ä»¬éœ€è¦ä¿®æ”¹ URLï¼Œå› ä¸ºå®ƒç°åœ¨é‡‡ç”¨äº† *path variable*ï¼
å’Œä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ rest è°ƒç”¨å¹¶å°†å“åº”ä¸ serviceã€repository æ–¹æ³•è°ƒç”¨è¿›è¡Œæ¯”è¾ƒã€‚

[source,java]
----
@Test
@Sql(statements = "INSERT INTO orders(id, buyer, price, qty) VALUES (20, 'sam', 50, 4)", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(statements = "DELETE FROM orders WHERE id='20'", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public void testOrderById() throws JsonProcessingException {
    HttpEntity<String> entity = new HttpEntity<>(null, headers);
    ResponseEntity<Order> response = restTemplate.exchange(
            (createURLWithPort() + "/20"), HttpMethod.GET, entity, Order.class);
    Order orderRes = response.getBody();
    String expected = "{\"id\":20,\"buyer\":\"sam\",\"price\":50.0,\"qty\":4}";
    assertEquals(response.getStatusCodeValue(), 200);
    assertEquals(expected, objectMapper.writeValueAsString(orderRes));
    assert orderRes != null;
    assertEquals(orderRes, orderService.getOrderById(20L));
    assertEquals(orderRes.getBuyer(), orderService.getOrderById(20L).getBuyer());
    assertEquals(orderRes, orderRepository.findById(20L).orElse(null));
}
----

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ä¸º**åˆ›å»ºæ–°è®¢å•çš„æ–¹æ³•**ç¼–å†™ä¸€ä¸ªé›†æˆæµ‹è¯•ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ POST è°ƒç”¨ã€‚
ç„¶åæˆ‘ä»¬å¿…é¡»æä¾›ä¸€ä¸ªæ–¹æ³•ä½“ã€‚
åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²çš„è®¢å•å¯¹è±¡æ¥æ›´æ–° *HttpEntity*ã€‚

è€Œä¸”æˆ‘ä»¬ä¸éœ€è¦ 2ï¸ ä¸ª SQL å‘½ä»¤ã€‚
ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨æ–¹æ³•æœ¬èº«å†…éƒ¨åˆ›å»ºå¹¶ä¿å­˜äº†ä¸€ä¸ªå¯¹è±¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œæµ‹è¯•æ–¹æ³•åå°†å…¶åˆ é™¤å³å¯ã€‚


[source,java]
----
@Test
@Sql(statements = "DELETE FROM orders WHERE id='3'", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public void testCreateOrder() throws JsonProcessingException {
    Order order = new Order(3L, "peter", 30.0, 3);
    HttpEntity<String> entity = new HttpEntity<>(objectMapper.writeValueAsString(order), headers);
    ResponseEntity<Order> response = restTemplate.exchange(
            createURLWithPort(), HttpMethod.POST, entity, Order.class);
    assertEquals(response.getStatusCodeValue(), 201);
    Order orderRes = Objects.requireNonNull(response.getBody());
    assertEquals(orderRes.getBuyer(), "peter");
    assertEquals(orderRes.getBuyer(), orderRepository.save(order).getBuyer());
}
----

ğŸ‘‰ âœ”ï¸ è®©æˆ‘ä»¬ä¸º**åˆ é™¤ Order çš„æ–¹æ³•**ç¼–å†™ä¸€ä¸ªé›†æˆæµ‹è¯•ã€‚
æµ‹è¯•åº”åœ¨äº¤æ¢æ–¹æ³•ä¸­ä½¿ç”¨ DELETE ç±»å‹ç¼–å†™ã€‚
æˆ‘ä»¬éœ€è¦ä¿®æ”¹ URLï¼Œå› ä¸ºç°åœ¨å®ƒé‡‡ç”¨äº† *path variable*ï¼
æˆ‘åœ¨ controller å±‚ä¸­ä¸ºåˆ é™¤æ–¹æ³•è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚
å› æ­¤ï¼Œæˆ‘å·²ç»ä½¿ç”¨ JUnit æ£€æŸ¥äº†è¯¥å­—ç¬¦ä¸²ä»¥è¿›è¡ŒéªŒè¯ã€‚

[source,java]
----
@Test
@Sql(statements = "INSERT INTO orders(id, buyer, price, qty) VALUES (6, 'alex', 75, 3)", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(statements = "DELETE FROM orders WHERE id='6'", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public void testDeleteOrder() {
    ResponseEntity<String> response = restTemplate.exchange(
            (createURLWithPort() + "/6"), HttpMethod.DELETE, null, String.class);
    String orderRes = response.getBody();
    assertEquals(response.getStatusCodeValue(), 200);
    assertNotNull(orderRes);
    assertEquals(orderRes, "Order deleted - Order ID:6");
}
----

ç°åœ¨æˆ‘ä»¬å¾®æœåŠ¡çš„æ‰€æœ‰é›†æˆæ¡ˆä¾‹éƒ½å·²å®Œæˆï¼â¤ï¸